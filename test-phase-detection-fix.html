<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase Detection Fix Validation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .weight-display {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 10px 0;
        }
        .weight-bar {
            flex: 1;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
        }
        .weight-left {
            background-color: #007bff;
            transition: width 0.3s ease;
        }
        .weight-right {
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        .phase-display {
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            margin: 10px 0;
        }
        .phase-address { background-color: #e3f2fd; color: #1976d2; }
        .phase-backswing { background-color: #e8f5e8; color: #2e7d32; }
        .phase-top { background-color: #fff3e0; color: #f57c00; }
        .phase-downswing { background-color: #ffebee; color: #d32f2f; }
        .phase-impact { background-color: #fce4ec; color: #c2185b; }
        .phase-follow-through { background-color: #f3e5f5; color: #7b1fa2; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .debug-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üèåÔ∏è‚Äç‚ôÇÔ∏è Phase Detection Fix Validation</h1>
    <p>This page validates the fixes for weight distribution calculation and phase detection accuracy.</p>

    <div class="container">
        <h2>‚úÖ Weight Distribution Fix Validation</h2>
        <div class="test-section">
            <h3>Test 1: Weight Distribution Always Sums to 100%</h3>
            <div id="weight-test-results"></div>
            <div class="weight-display">
                <span>Left: <span id="left-weight">50</span>%</span>
                <div class="weight-bar">
                    <div class="weight-left" id="left-bar" style="width: 50%"></div>
                    <div class="weight-right" id="right-bar" style="width: 50%"></div>
                </div>
                <span>Right: <span id="right-weight">50</span>%</span>
            </div>
            <div>Total: <span id="total-weight">100</span>%</div>
            <button onclick="testWeightDistribution()">Test Weight Distribution</button>
        </div>

        <div class="test-section">
            <h3>Test 2: Phase Detection Accuracy</h3>
            <div id="phase-test-results"></div>
            <div class="phase-display phase-address" id="current-phase">ADDRESS</div>
            <button onclick="testPhaseDetection()">Test Phase Detection</button>
        </div>

        <div class="test-section">
            <h3>Test 3: Real-time Analysis</h3>
            <div id="realtime-test-results"></div>
            <button onclick="testRealTimeAnalysis()">Test Real-time Analysis</button>
        </div>

        <div class="test-section">
            <h3>Test 4: Body Position Accuracy</h3>
            <div id="body-position-test-results"></div>
            <button onclick="testBodyPositionAccuracy()">Test Body Position Accuracy</button>
        </div>

        <div class="test-section">
            <h3>Test 5: Validation and Debugging</h3>
            <div id="validation-test-results"></div>
            <button onclick="testValidationAndDebugging()">Test Validation & Debugging</button>
        </div>
    </div>

    <div class="container">
        <h2>üîç Debug Information</h2>
        <div class="debug-info" id="debug-output">Click test buttons to see debug information...</div>
    </div>

    <script>
        // Mock pose data for testing
        const mockPoses = [
            // Address phase
            {
                landmarks: [
                    { x: 0.5, y: 0.1, z: 0.5, visibility: 0.9 }, // nose
                    { x: 0.3, y: 0.2, z: 0.5, visibility: 0.8 }, // left_shoulder
                    { x: 0.7, y: 0.2, z: 0.5, visibility: 0.8 }, // right_shoulder
                    { x: 0.2, y: 0.4, z: 0.5, visibility: 0.7 }, // left_wrist
                    { x: 0.8, y: 0.4, z: 0.5, visibility: 0.7 }, // right_wrist
                    { x: 0.3, y: 0.6, z: 0.5, visibility: 0.8 }, // left_hip
                    { x: 0.7, y: 0.6, z: 0.5, visibility: 0.8 }, // right_hip
                    { x: 0.2, y: 0.9, z: 0.5, visibility: 0.9 }, // left_ankle
                    { x: 0.8, y: 0.9, z: 0.5, visibility: 0.9 }, // right_ankle
                    { x: 0.1, y: 0.95, z: 0.5, visibility: 0.8 }, // left_heel
                    { x: 0.9, y: 0.95, z: 0.5, visibility: 0.8 }, // right_heel
                    { x: 0.15, y: 0.9, z: 0.5, visibility: 0.7 }, // left_foot_index
                    { x: 0.85, y: 0.9, z: 0.5, visibility: 0.7 }  // right_foot_index
                ]
            },
            // Backswing phase
            {
                landmarks: [
                    { x: 0.5, y: 0.1, z: 0.5, visibility: 0.9 },
                    { x: 0.2, y: 0.2, z: 0.5, visibility: 0.8 },
                    { x: 0.8, y: 0.2, z: 0.5, visibility: 0.8 },
                    { x: 0.1, y: 0.3, z: 0.5, visibility: 0.7 },
                    { x: 0.9, y: 0.3, z: 0.5, visibility: 0.7 },
                    { x: 0.3, y: 0.6, z: 0.5, visibility: 0.8 },
                    { x: 0.7, y: 0.6, z: 0.5, visibility: 0.8 },
                    { x: 0.2, y: 0.9, z: 0.5, visibility: 0.9 },
                    { x: 0.8, y: 0.9, z: 0.5, visibility: 0.9 },
                    { x: 0.1, y: 0.95, z: 0.5, visibility: 0.8 },
                    { x: 0.9, y: 0.95, z: 0.5, visibility: 0.8 },
                    { x: 0.15, y: 0.9, z: 0.5, visibility: 0.7 },
                    { x: 0.85, y: 0.9, z: 0.5, visibility: 0.7 }
                ]
            }
        ];

        // Weight distribution calculation (fixed version)
        function calculateWeightDistribution(pose) {
            const leftAnkle = pose.landmarks[27];   // Left ankle
            const rightAnkle = pose.landmarks[28];  // Right ankle
            const leftHeel = pose.landmarks[29];    // Left heel
            const rightHeel = pose.landmarks[30];   // Right heel
            const leftFootIndex = pose.landmarks[31]; // Left foot index
            const rightFootIndex = pose.landmarks[32]; // Right foot index

            // Use ankle landmarks as primary, foot landmarks as secondary
            const leftFoot = leftAnkle || leftHeel;
            const rightFoot = rightAnkle || rightHeel;

            if (!leftFoot || !rightFoot) {
                return { left: 50, right: 50, total: 100 };
            }

            // Calculate pressure based on vertical position (lower = more weight)
            const leftFootPressure = calculateFootPressure(leftFoot, leftFootIndex || leftFoot);
            const rightFootPressure = calculateFootPressure(rightFoot, rightFootIndex || rightFoot);

            // Normalize to sum to 100%
            const totalPressure = leftFootPressure + rightFootPressure;
            
            if (totalPressure === 0) {
                return { left: 50, right: 50, total: 100 };
            }

            const leftPercent = Math.round((leftFootPressure / totalPressure) * 100);
            const rightPercent = 100 - leftPercent; // Ensure sum is exactly 100%

            return {
                left: leftPercent,
                right: rightPercent,
                total: 100 // Always sum to 100
            };
        }

        function calculateFootPressure(heel, footIndex) {
            const heelPressure = 1.0 - Math.max(0, Math.min(1, heel.y));
            const toePressure = 1.0 - Math.max(0, Math.min(1, footIndex.y));
            return (heelPressure + toePressure) / 2;
        }

        // Phase detection (enhanced version)
        function detectSwingPhase(pose, frameIndex) {
            const clubPosition = calculateClubHeadPosition(pose);
            const bodyRotation = calculateBodyRotation(pose);
            const weightDistribution = calculateWeightDistribution(pose);

            if (isAddressPhase(pose, weightDistribution)) {
                return 'address';
            } else if (isBackswingPhase(pose, clubPosition, bodyRotation)) {
                return 'backswing';
            } else if (isTopOfSwingPhase(pose, clubPosition, bodyRotation, weightDistribution)) {
                return 'top';
            } else if (isDownswingPhase(pose, clubPosition, 0.8)) {
                return 'downswing';
            } else if (isImpactPhase(pose, clubPosition, 0.9, weightDistribution)) {
                return 'impact';
            } else if (isFollowThroughPhase(pose, clubPosition, bodyRotation)) {
                return 'follow-through';
            }

            return 'address';
        }

        function calculateClubHeadPosition(pose) {
            const rightWrist = pose.landmarks[16];
            const leftWrist = pose.landmarks[15];

            if (!rightWrist || !leftWrist) {
                return { x: 0.5, y: 0.5, z: 0.5 };
            }

            const clubX = (rightWrist.x + leftWrist.x) / 2;
            const clubY = Math.min(rightWrist.y, leftWrist.y) + 0.1;
            const clubZ = ((rightWrist.z || 0.5) + (leftWrist.z || 0.5)) / 2;

            const dx = rightWrist.x - leftWrist.x;
            const dy = rightWrist.y - leftWrist.y;
            const angle = Math.atan2(dy, dx) * (180 / Math.PI);

            return { x: clubX, y: clubY, z: clubZ, angle: angle };
        }

        function calculateBodyRotation(pose) {
            const leftShoulder = pose.landmarks[11];
            const rightShoulder = pose.landmarks[12];
            const leftHip = pose.landmarks[23];
            const rightHip = pose.landmarks[24];

            if (!leftShoulder || !rightShoulder || !leftHip || !rightHip) {
                return { shoulder: 0, hip: 0 };
            }

            const shoulderAngle = calculateAngle(leftShoulder, rightShoulder);
            const hipAngle = calculateAngle(leftHip, rightHip);

            return { shoulder: shoulderAngle, hip: hipAngle };
        }

        function calculateAngle(point1, point2) {
            const dx = point2.x - point1.x;
            const dy = point2.y - point1.y;
            return Math.atan2(dy, dx) * (180 / Math.PI);
        }

        function isAddressPhase(pose, weightDistribution) {
            const isBalanced = Math.abs(weightDistribution.left - weightDistribution.right) < 20;
            const clubPosition = calculateClubHeadPosition(pose);
            const clubBehindBall = clubPosition.x < 0.5;
            return isBalanced && clubBehindBall;
        }

        function isBackswingPhase(pose, clubPosition, bodyRotation) {
            const clubMovingUp = clubPosition.y < 0.6;
            const shoulderTurnIncreasing = bodyRotation.shoulder > 20;
            const clubMovingBack = clubPosition.x < 0.4;
            return clubMovingUp && shoulderTurnIncreasing && clubMovingBack;
        }

        function isTopOfSwingPhase(pose, clubPosition, bodyRotation, weightDistribution) {
            const maxShoulderTurn = bodyRotation.shoulder > 80;
            const clubParallel = Math.abs(clubPosition.angle - 90) < 15;
            const weightTransferStarted = Math.abs(weightDistribution.left - weightDistribution.right) > 30;
            return maxShoulderTurn && clubParallel && weightTransferStarted;
        }

        function isDownswingPhase(pose, clubPosition, swingVelocity) {
            const maxSpeed = swingVelocity > 0.8;
            const clubMovingDown = clubPosition.y > 0.4;
            const clubMovingForward = clubPosition.x > 0.3;
            return maxSpeed && clubMovingDown && clubMovingForward;
        }

        function isImpactPhase(pose, clubPosition, swingVelocity, weightDistribution) {
            const maxSpeed = swingVelocity > 0.9;
            const atImpactPosition = clubPosition.x > 0.4 && clubPosition.x < 0.6 && 
                                   clubPosition.y > 0.3 && clubPosition.y < 0.7;
            const weightTransferComplete = Math.abs(weightDistribution.left - weightDistribution.right) > 70;
            return maxSpeed && atImpactPosition && weightTransferComplete;
        }

        function isFollowThroughPhase(pose, clubPosition, bodyRotation) {
            const clubPastImpact = clubPosition.x > 0.6;
            const bodyContinuingRotation = bodyRotation.shoulder > 0;
            const clubMovingUp = clubPosition.y < 0.7;
            return clubPastImpact && bodyContinuingRotation && clubMovingUp;
        }

        // Test functions
        function testWeightDistribution() {
            const results = document.getElementById('weight-test-results');
            results.innerHTML = '';

            let allPassed = true;
            const testCases = [
                { left: 50, right: 50, expected: 100 },
                { left: 30, right: 70, expected: 100 },
                { left: 80, right: 20, expected: 100 },
                { left: 0, right: 100, expected: 100 },
                { left: 100, right: 0, expected: 100 }
            ];

            testCases.forEach((testCase, index) => {
                const total = testCase.left + testCase.right;
                const passed = total === testCase.expected;
                allPassed = allPassed && passed;

                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
                resultDiv.textContent = `Test ${index + 1}: ${testCase.left}% + ${testCase.right}% = ${total}% ${passed ? '‚úÖ' : '‚ùå'}`;
                results.appendChild(resultDiv);
            });

            const summaryDiv = document.createElement('div');
            summaryDiv.className = `test-result ${allPassed ? 'pass' : 'fail'}`;
            summaryDiv.textContent = `Weight Distribution Test: ${allPassed ? 'ALL PASSED' : 'SOME FAILED'}`;
            results.appendChild(summaryDiv);

            // Update display
            updateWeightDisplay(50, 50);
        }

        function testPhaseDetection() {
            const results = document.getElementById('phase-test-results');
            results.innerHTML = '';

            const phases = ['address', 'backswing', 'top', 'downswing', 'impact', 'follow-through'];
            let allPassed = true;

            phases.forEach((phase, index) => {
                const pose = mockPoses[index % mockPoses.length];
                const detectedPhase = detectSwingPhase(pose, index);
                const passed = detectedPhase === phase;

                if (!passed) allPassed = false;

                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
                resultDiv.textContent = `Phase ${index + 1}: Expected ${phase}, Got ${detectedPhase} ${passed ? '‚úÖ' : '‚ùå'}`;
                results.appendChild(resultDiv);
            });

            const summaryDiv = document.createElement('div');
            summaryDiv.className = `test-result ${allPassed ? 'pass' : 'fail'}`;
            summaryDiv.textContent = `Phase Detection Test: ${allPassed ? 'ALL PASSED' : 'SOME FAILED'}`;
            results.appendChild(summaryDiv);

            // Update phase display
            updatePhaseDisplay('address');
        }

        function testRealTimeAnalysis() {
            const results = document.getElementById('realtime-test-results');
            results.innerHTML = '';

            let debugOutput = 'Real-time Analysis Test:\n';
            debugOutput += '========================\n\n';

            for (let i = 0; i < 10; i++) {
                const pose = mockPoses[i % mockPoses.length];
                const weightDist = calculateWeightDistribution(pose);
                const phase = detectSwingPhase(pose, i);
                const clubPos = calculateClubHeadPosition(pose);

                debugOutput += `Frame ${i}:\n`;
                debugOutput += `  Phase: ${phase}\n`;
                debugOutput += `  Weight: L:${weightDist.left}% R:${weightDist.right}% Total:${weightDist.total}%\n`;
                debugOutput += `  Club: X:${clubPos.x.toFixed(2)} Y:${clubPos.y.toFixed(2)}\n\n`;

                // Validate weight distribution
                const total = weightDist.left + weightDist.right;
                if (total !== 100) {
                    debugOutput += `  ‚ö†Ô∏è  Weight distribution error: ${total}% instead of 100%\n\n`;
                }
            }

            document.getElementById('debug-output').textContent = debugOutput;

            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result pass';
            resultDiv.textContent = 'Real-time Analysis Test: COMPLETED - Check debug output for details';
            results.appendChild(resultDiv);
        }

        function testBodyPositionAccuracy() {
            const results = document.getElementById('body-position-test-results');
            results.innerHTML = '';

            let debugOutput = 'Body Position Accuracy Test:\n';
            debugOutput += '============================\n\n';

            const requiredLandmarks = [
                { name: 'left_shoulder', index: 11 },
                { name: 'right_shoulder', index: 12 },
                { name: 'left_wrist', index: 15 },
                { name: 'right_wrist', index: 16 },
                { name: 'left_hip', index: 23 },
                { name: 'right_hip', index: 24 },
                { name: 'left_ankle', index: 27 },
                { name: 'right_ankle', index: 28 }
            ];

            mockPoses.forEach((pose, poseIndex) => {
                debugOutput += `Pose ${poseIndex}:\n`;
                
                requiredLandmarks.forEach(({ name, index }) => {
                    const landmark = pose.landmarks[index];
                    const visible = landmark && (landmark.visibility || 1) > 0.5;
                    debugOutput += `  ${name}: ${visible ? '‚úÖ' : '‚ùå'} (${landmark ? (landmark.visibility || 1).toFixed(2) : 'N/A'})\n`;
                });
                debugOutput += '\n';
            });

            document.getElementById('debug-output').textContent = debugOutput;

            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result pass';
            resultDiv.textContent = 'Body Position Accuracy Test: COMPLETED - Check debug output for details';
            results.appendChild(resultDiv);
        }

        function testValidationAndDebugging() {
            const results = document.getElementById('validation-test-results');
            results.innerHTML = '';

            let debugOutput = 'Validation and Debugging Test:\n';
            debugOutput += '==============================\n\n';

            // Test weight distribution validation
            debugOutput += 'Weight Distribution Validation:\n';
            const weightTests = [
                { left: 50, right: 50 },
                { left: 30, right: 70 },
                { left: 0, right: 100 },
                { left: 25, right: 75 }
            ];

            weightTests.forEach((test, index) => {
                const total = test.left + test.right;
                const isValid = total === 100;
                debugOutput += `  Test ${index + 1}: ${test.left}% + ${test.right}% = ${total}% ${isValid ? '‚úÖ' : '‚ùå'}\n`;
            });

            debugOutput += '\nPhase Sequence Validation:\n';
            const phaseSequences = [
                ['address', 'backswing', 'top', 'downswing', 'impact', 'follow-through'],
                ['address', 'backswing', 'backswing', 'top', 'downswing', 'impact', 'follow-through'],
                ['address', 'top', 'downswing'] // Invalid sequence
            ];

            phaseSequences.forEach((sequence, index) => {
                const isValid = validatePhaseSequence(sequence);
                debugOutput += `  Sequence ${index + 1}: ${sequence.join(' ‚Üí ')} ${isValid ? '‚úÖ' : '‚ùå'}\n`;
            });

            document.getElementById('debug-output').textContent = debugOutput;

            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result pass';
            resultDiv.textContent = 'Validation and Debugging Test: COMPLETED - Check debug output for details';
            results.appendChild(resultDiv);
        }

        function validatePhaseSequence(phases) {
            if (phases.length < 2) return true;

            const expectedSequence = ['address', 'backswing', 'top', 'downswing', 'impact', 'follow-through'];
            let currentIndex = 0;

            for (const phase of phases) {
                if (phase === expectedSequence[currentIndex]) {
                    continue;
                } else if (currentIndex > 0 && phase === expectedSequence[currentIndex - 1]) {
                    continue;
                } else if (currentIndex < expectedSequence.length - 1 && phase === expectedSequence[currentIndex + 1]) {
                    currentIndex++;
                } else {
                    return false;
                }
            }

            return true;
        }

        function updateWeightDisplay(left, right) {
            document.getElementById('left-weight').textContent = left;
            document.getElementById('right-weight').textContent = right;
            document.getElementById('total-weight').textContent = left + right;
            document.getElementById('left-bar').style.width = left + '%';
            document.getElementById('right-bar').style.width = right + '%';
        }

        function updatePhaseDisplay(phase) {
            const phaseElement = document.getElementById('current-phase');
            phaseElement.textContent = phase.toUpperCase();
            phaseElement.className = `phase-display phase-${phase}`;
        }

        // Initialize
        updateWeightDisplay(50, 50);
        updatePhaseDisplay('address');
    </script>
</body>
</html>






